# Hitomi.la ä¸‹è½½åŠŸèƒ½æŠ€æœ¯è§„æ ¼æ–‡æ¡£

## ğŸ“Œ æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½• Hitomi.la ç”»å»Šé¡µé¢çš„ä¸‹è½½æœºåˆ¶ï¼Œç”¨äºï¼š
1. äººç±»ç†è§£ä¸‹è½½æµç¨‹çš„å®Œæ•´é€»è¾‘
2. AI æ ¹æ®æ­¤è§„æ ¼ç›´æ¥ç”Ÿæˆç­‰æ•ˆä¸‹è½½è„šæœ¬ï¼Œæ— éœ€é‡æ–°åˆ†æç½‘é¡µ

---

## ä¸€ã€é¡µé¢åŠ è½½åå¯è·å–çš„å…³é”®æ•°æ®

### 1.1 ç”»å»Šå…ƒæ•°æ® (`galleryinfo` å¯¹è±¡)

é¡µé¢åŠ è½½æ—¶ï¼Œä¼šé€šè¿‡ `<script>` æ ‡ç­¾æˆ– AJAX è¯·æ±‚è·å–ç”»å»Šä¿¡æ¯ï¼š

```javascript
// å…³é”®å­—æ®µ
galleryinfo = {
    id: "3669332",                    // ç”»å»ŠID
    title: "Step Sis x Big Bro",      // è‹±æ–‡æ ‡é¢˜
    japanese_title: "ì¡°ê·¸ë§Œ ëˆ„ë‚˜ì™€ í° ë™ìƒ", // æ—¥æ–‡/åŸæ–‡æ ‡é¢˜ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    files: [                          // å›¾ç‰‡åˆ—è¡¨ï¼ˆæ ¸å¿ƒæ•°æ®ï¼‰
        {
            name: "001.jpg",          // åŸå§‹æ–‡ä»¶å
            hash: "61ba4fcf5c1df1c4d2e3a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d69f2",  // 64ä½åå…­è¿›åˆ¶å“ˆå¸Œ
            width: 1200,              // å›¾ç‰‡å®½åº¦
            height: 1800,             // å›¾ç‰‡é«˜åº¦
            hasavif: 1                // æ˜¯å¦æœ‰ AVIF æ ¼å¼ï¼ˆ1æœ‰/0æ— ï¼‰
        },
        // ... æ›´å¤šå›¾ç‰‡
    ]
}
```

### 1.2 åŠ¨æ€é…ç½® (`gg.js` æä¾›)

æ­¤é…ç½®ä¼š**å®šæœŸå˜åŒ–**ï¼Œéœ€ä»é¡µé¢å®æ—¶è·å–ï¼š

```javascript
gg = {
    b: "1764889202/",  // åŸºç¡€è·¯å¾„å‰ç¼€ï¼ˆä¼šå®šæœŸæ›´æ¢ï¼‰
    s: function(h) {   // hash è½¬æ•°å­—è·¯å¾„çš„ç®—æ³•
        var m = /(..)(.)$/.exec(h);
        return parseInt(m[2] + m[1], 16).toString(10);
    },
    m: function(g) {   // CDNè´Ÿè½½å‡è¡¡å†³ç­–ï¼ˆè¿”å›0æˆ–1ï¼‰
        // åŒ…å«å¤§é‡ case è¯­å¥çš„ switch
        // åŒ¹é…ç‰¹å®šæ•°å­—è¿”å› 0ï¼Œå¦åˆ™è¿”å› 1
    }
}
```

### 1.3 å›ºå®šå¸¸é‡

```javascript
domain2 = "gold-usergeneratedcontent.net";  // CDN åŸŸåï¼ˆå¶å°”å˜åŒ–ï¼‰
```

---

## äºŒã€å›¾ç‰‡ URL æ„å»ºç®—æ³•

### 2.1 å®Œæ•´å…¬å¼

å¯¹äºæ¯å¼ å›¾ç‰‡ï¼Œæœ€ç»ˆä¸‹è½½ URL çš„æ„å»ºå…¬å¼ä¸ºï¼š

```
https://{subdomain}.{domain2}/{gg.b}{gg.s(hash)}/{hash}.{ext}
```

### 2.2 å„éƒ¨åˆ†è®¡ç®—æ–¹æ³•

#### 2.2.1 è®¡ç®— `gg.s(hash)` â€” æ•°å­—è·¯å¾„

```javascript
function calculate_path_number(hash) {
    // æå– hash æœ€å 3 ä¸ªå­—ç¬¦
    var m = /(..)(.)$/.exec(hash);
    // m[1] = å€’æ•°ç¬¬2-3ä½, m[2] = æœ€å1ä½
    // é‡æ–°æ’åˆ—åä»16è¿›åˆ¶è½¬10è¿›åˆ¶
    return parseInt(m[2] + m[1], 16).toString(10);
}

// ç¤ºä¾‹
// hash = "...abc9f2"
// m[1] = "9f", m[2] = "2"
// ç»“æœ = parseInt("29f", 16) = 671
```

#### 2.2.2 è®¡ç®— `subdomain` â€” CDN å­åŸŸå

```javascript
function calculate_subdomain(hash, format) {
    // 1. æ ¹æ®æ ¼å¼ç¡®å®šå‰ç¼€
    var prefix = "";
    if (format === "webp") prefix = "w";
    else if (format === "avif") prefix = "a";
    
    // 2. ä» hash ä¸­æå–ç”¨äºè´Ÿè½½å‡è¡¡çš„æ•°å­—
    //    æå–å€’æ•°ç¬¬2-3ä½å’Œæœ€å1ä½ï¼ˆå…±3ä½ï¼‰
    var m = /([0-9a-f]{2})([0-9a-f])$/.exec(hash);
    var g = parseInt(m[2] + m[1], 16);  // é‡æ’åè½¬æ•°å­—
    
    // 3. é€šè¿‡ gg.m(g) å†³å®šæœåŠ¡å™¨ç¼–å·ï¼ˆ0 æˆ– 1ï¼‰
    var server_number = gg.m(g);  // è¿”å› 0 æˆ– 1
    
    // 4. ç»„åˆå­åŸŸå
    //    æœåŠ¡å™¨ç¼–å· + 1 â†’ å®é™…ä½¿ç”¨ 1 æˆ– 2
    return prefix + (1 + server_number);
}

// ç¤ºä¾‹
// hash æœ«å°¾ = "9f2", format = "webp"
// g = parseInt("29f", 16) = 671
// gg.m(671) = 1ï¼ˆå‡è®¾ä¸åœ¨ç‰¹æ®Šåˆ—è¡¨ä¸­ï¼‰
// subdomain = "w" + (1+1) = "w2"
```

#### 2.2.3 å®Œæ•´ URL ç»„è£…

```javascript
function build_image_url(image, format) {
    var hash = image.hash;
    var subdomain = calculate_subdomain(hash, format);
    var path_number = calculate_path_number(hash);
    
    return `https://${subdomain}.${domain2}/${gg.b}${path_number}/${hash}.${format}`;
}

// ç¤ºä¾‹è¾“å‡º
// https://w2.gold-usergeneratedcontent.net/1764889202/671/61ba4fc...9f2.webp
```

---

## ä¸‰ã€ä¸‹è½½æµç¨‹è§„æ ¼

### 3.1 æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: è·å–æ•°æ®                                              â”‚
â”‚ - ä»é¡µé¢æå– galleryinfoï¼ˆå« files æ•°ç»„ï¼‰                    â”‚
â”‚ - ä»é¡µé¢æå– gg å¯¹è±¡ï¼ˆb, s, m å‡½æ•°ï¼‰                         â”‚
â”‚ - ä»é¡µé¢æå– domain2                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: æ„å»º URL åˆ—è¡¨                                         â”‚
â”‚ - éå† galleryinfo.files                                     â”‚
â”‚ - å¯¹æ¯å¼ å›¾è°ƒç”¨ build_image_url(image, "webp")               â”‚
â”‚ - æ”¶é›†æ‰€æœ‰ URL å’Œå¯¹åº”æ–‡ä»¶å                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: èŠ‚æµä¸‹è½½                                              â”‚
â”‚ - æ¯ç§’æœ€å¤šä¸‹è½½ 1 å¼ å›¾ç‰‡ï¼ˆé—´éš” â‰¥ 1000msï¼‰                     â”‚
â”‚ - ä½¿ç”¨ XHR/fetch è·å–äºŒè¿›åˆ¶æ•°æ®                              â”‚
â”‚ - å¤±è´¥æ—¶é‡è¯• 3 æ¬¡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤4: æ‰“åŒ…ä¿å­˜                                              â”‚
â”‚ - ä½¿ç”¨ JSZip å°†æ‰€æœ‰å›¾ç‰‡æ‰“åŒ…                                  â”‚
â”‚ - æ–‡ä»¶åæ ¼å¼: {åŸæ–‡ä»¶å}.webpï¼ˆæ›¿æ¢åŸæ‰©å±•åï¼‰                â”‚
â”‚ - ZIP æ–‡ä»¶å: {japanese_title || title}.zip                 â”‚
â”‚ - ä½¿ç”¨ FileSaver è§¦å‘ä¸‹è½½                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…³é”®å‚æ•°è§„æ ¼

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| ä¸‹è½½æ ¼å¼ | `webp` | ä¼˜å…ˆä½¿ç”¨ webpï¼ˆä¹Ÿæ”¯æŒ avif/åŸæ ¼å¼ï¼‰ |
| èŠ‚æµé—´éš” | `1000ms` | æ¯ç§’æœ€å¤š 1 æ¬¡è¯·æ±‚ |
| é‡è¯•æ¬¡æ•° | `3` | ä¸‹è½½å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•° |
| è¯·æ±‚ç±»å‹ | `arraybuffer` | è·å–äºŒè¿›åˆ¶æ•°æ® |

### 3.3 æ–‡ä»¶å‘½åè§„åˆ™

```javascript
// è¾“å…¥: image.name = "001.jpg"
// è¾“å‡º: "001.webp"
output_filename = image.name.replace(/[^.]*$/, 'webp');
```

---

## å››ã€`gg.m()` å‡½æ•°è§„æ ¼

### 4.1 åŠŸèƒ½

æ ¹æ®è®¡ç®—å‡ºçš„æ•°å­— `g` å†³å®šä½¿ç”¨å“ªä¸ª CDN æœåŠ¡å™¨ï¼š
- è¿”å› `0` â†’ ä½¿ç”¨æœåŠ¡å™¨ 1ï¼ˆå¦‚ `w1`ï¼‰
- è¿”å› `1` â†’ ä½¿ç”¨æœåŠ¡å™¨ 2ï¼ˆå¦‚ `w2`ï¼‰

### 4.2 å®ç°æ–¹å¼

```javascript
gg.m = function(g) {
    var o = 1;  // é»˜è®¤è¿”å› 1
    switch (g) {
        // ç‰¹å®šæ•°å­—è¿”å› 0
        case 863:
        case 1057:
        case 554:
        // ... æ•°ç™¾ä¸ª case
        case 750:
            o = 0;
            break;
    }
    return o;
}
```

### 4.3 é‡è¦è¯´æ˜

**æ­¤å‡½æ•°ä¼šåŠ¨æ€å˜åŒ–ï¼** æœåŠ¡å™¨ä¼šæ ¹æ®è´Ÿè½½è°ƒæ•´ case åˆ—è¡¨ã€‚

ç”Ÿæˆè„šæœ¬æ—¶å¿…é¡»ï¼š
1. å®æ—¶ä» `https://ltn.gold-usergeneratedcontent.net/gg.js` è·å–æœ€æ–°ç‰ˆæœ¬
2. æˆ–ä»é¡µé¢çš„ `<script>` æ ‡ç­¾ä¸­æå–

---

## äº”ã€ç”Ÿæˆä¼˜åŒ–è„šæœ¬çš„è¦æ±‚

åŸºäºä»¥ä¸Šè§„æ ¼ï¼Œç”Ÿæˆçš„è„šæœ¬åº”æ»¡è¶³ï¼š

### 5.1 åŠŸèƒ½è¦æ±‚

1. **è·å–é¡µé¢æ•°æ®**
   - è‡ªåŠ¨æå– `galleryinfo`ã€`gg` å¯¹è±¡ã€`domain2`
   - æ”¯æŒä»å½“å‰é¡µé¢æˆ–æŒ‡å®š URL è·å–

2. **æ„å»ºä¸‹è½½ URL**
   - å®ç° `gg.s()` çš„é€»è¾‘
   - å®ç° `calculate_subdomain()` çš„é€»è¾‘
   - å®ç°å®Œæ•´ URL ç»„è£…

3. **ä¸‹è½½ç®¡ç†**
   - èŠ‚æµæ§åˆ¶ï¼ˆâ‰¥1ç§’/å¼ ï¼‰
   - å¤±è´¥é‡è¯•ï¼ˆ3æ¬¡ï¼‰
   - è¿›åº¦æ˜¾ç¤º

4. **æ‰“åŒ…ä¿å­˜**
   - ZIP æ‰“åŒ…
   - æ­£ç¡®çš„æ–‡ä»¶å‘½å

### 5.2 ä¼˜åŒ–æ–¹å‘

| åŸç‰ˆé—®é¢˜ | ä¼˜åŒ–æ–¹æ¡ˆ |
|---------|---------|
| èŠ‚æµé—´éš”å›ºå®š1ç§’ | å¯é…ç½®é—´éš”ï¼Œæ”¯æŒæ›´å¿«/æ›´æ…¢ |
| æ— å¹¶å‘ä¸‹è½½ | æ”¯æŒå¯é…ç½®çš„å¹¶å‘æ•°ï¼ˆå¦‚3å¹¶å‘ï¼‰ |
| æ— æ–­ç‚¹ç»­ä¼  | è®°å½•å·²ä¸‹è½½æ–‡ä»¶ï¼Œæ”¯æŒç»§ç»­ |
| æ— æ ¼å¼é€‰æ‹© | æ”¯æŒ webp/avif/åŸæ ¼å¼ é€‰æ‹© |
| ä¾èµ– jQuery | ä½¿ç”¨åŸç”Ÿ JSï¼Œå‡å°‘ä¾èµ– |

### 5.3 è„šæœ¬æ¨¡æ¿ç»“æ„

```javascript
// ========== å¯é…ç½®å‚æ•° ==========
const CONFIG = {
    format: 'webp',           // ä¸‹è½½æ ¼å¼: 'webp' | 'avif' | 'original'
    throttle_ms: 1000,        // èŠ‚æµé—´éš”ï¼ˆæ¯«ç§’ï¼‰
    max_concurrent: 1,        // æœ€å¤§å¹¶å‘æ•°
    max_retries: 3,           // æœ€å¤§é‡è¯•æ¬¡æ•°
};

// ========== ä»é¡µé¢è·å–çš„åŠ¨æ€æ•°æ® ==========
// galleryinfo, gg, domain2 éœ€å®æ—¶è·å–

// ========== æ ¸å¿ƒå‡½æ•° ==========
function calculate_path_number(hash) { /* ... */ }
function calculate_subdomain(hash, format) { /* ... */ }
function build_image_url(image, format) { /* ... */ }

// ========== ä¸‹è½½é€»è¾‘ ==========
async function download_with_retry(url, retries) { /* ... */ }
async function download_all_images() { /* ... */ }

// ========== æ‰“åŒ…ä¿å­˜ ==========
async function pack_and_save(images, filename) { /* ... */ }

// ========== ä¸»å…¥å£ ==========
async function main() { /* ... */ }
```

---

## å…­ã€å¿«é€Ÿå‚è€ƒ

### 6.1 URL æ„å»ºå…¬å¼ï¼ˆä¸€è¡Œç‰ˆï¼‰

```javascript
url = `https://${(format==='webp'?'w':format==='avif'?'a':'')+(1+gg.m(parseInt(hash.slice(-1)+hash.slice(-3,-1),16)))}.${domain2}/${gg.b}${parseInt(hash.slice(-1)+hash.slice(-3,-1),16)}/${hash}.${format}`;
```

### 6.2 å¿…éœ€è·å–çš„é¡µé¢å˜é‡

```javascript
// è¿™äº›å˜é‡å¿…é¡»ä»ç›®æ ‡é¡µé¢è·å–
const REQUIRED_DATA = {
    galleryinfo: window.galleryinfo,  // åŒ…å« files æ•°ç»„
    gg: window.gg,                     // åŒ…å« b, s, m
    domain2: window.domain2 || "gold-usergeneratedcontent.net"
};
```

### 6.3 æ–‡ä»¶è·å–é¡ºåº

1. ä¸»é¡µé¢ HTML â†’ æå– `galleryinfo`
2. `gg.js` â†’ æå– `gg` å¯¹è±¡ï¼ˆ**å¿…é¡»åŠ¨æ€è·å–**ï¼‰
3. é€å¼ ä¸‹è½½å›¾ç‰‡ â†’ æ‰“åŒ… â†’ ä¿å­˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**ç”Ÿæˆæ—¥æœŸ**: 2025å¹´  
**é€‚ç”¨åœºæ™¯**: ç”¨äºç”Ÿæˆ Hitomi.la ä¸‹è½½ä¼˜åŒ–è„šæœ¬