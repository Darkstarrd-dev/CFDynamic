<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最简 Function 示例</title>
</head>
<body>

    <h1>最简化的 Cloudflare Function 示例</h1>

    <!--
      1. (前端) 这是我们的请求按钮。
      我们将使用 JavaScript 给它添加一个点击事件。
    -->
    <button id="fetchButton">点击我来请求 Function</button>

    <h3>来自服务器的回复：</h3>

    <!--
      2. (前端) 这是我们的响应显示区域。
      我们使用 <pre> 标签，它可以保留文本格式（包括换行符），很适合显示原始响应。
    -->
    <pre id="responseBox" style="border: 1px solid #ccc; padding: 10px; min-height: 50px; background: #f9f9f9;">
        （等待请求...）
    </pre>

    <script>
        // 3. (前端) 等待整个 HTML 文档加载完毕后，再执行我们的 JavaScript。
        document.addEventListener('DOMContentLoaded', () => {

            // 4. (前端) 通过 ID 获取到我们在 HTML 中定义的元素。
            const button = document.getElementById('fetchButton');
            const responseBox = document.getElementById('responseBox');

            // 5. (前端) 给按钮添加一个“点击”事件监听器。
            button.addEventListener('click', () => {
                // 6. (前端) 当按钮被点击时，调用我们定义的 fetchData 函数。
                fetchData();
            });

            // 7. (前端) 定义一个异步函数 (async) 来处理网络请求。
            async function fetchData() {

                // 8. (前端) 在请求开始时，先更新显示区域的文本，给用户一个反馈。
                responseBox.textContent = '（正在请求服务器...）';

                try {
                    // 9. (前端)
                    //    这是最关键的一步：使用 fetch API 向我们的后端 Function 发送一个 GET 请求。
                    //    '/api/hello' 这个路径是 Cloudflare Pages 自动映射的。
                    //    它会去寻找你项目里 `functions/api/hello.js` 这个文件并执行它。
                    const response = await fetch('/api/hello');

                    // 10. (前端) 检查服务器的 HTTP 响应是否成功 (例如 200 OK)。
                    if (!response.ok) {
                        // 10a. (前端) 如果不成功，就抛出一个错误，这个错误会被下面的 catch 捕获。
                        throw new Error(`HTTP 错误！ 状态: ${response.status}`);
                    }

                    // 11. (前端) 如果响应成功，我们将响应体解析为纯文本。
                    const data = await response.text();

                    // 12. (前端) 将从服务器获取到的文本数据显示在响应区域里。
                    responseBox.textContent = data;

                } catch (error) {
                    // 13. (前端)
                    //    如果在 fetch 过程中（比如网络中断，或者上面的第 10a 步）发生了任何错误，
                    //    我们就在这里捕获它。
                    console.error('请求失败:', error);
                    // 14. (前端) 在响应区域显示一个清晰的错误信息，方便排查问题。
                    responseBox.textContent = `请求失败：\n${error}`;
                }
            }
        });
    </script>


</body>
</html>
