<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全栈统计系统架构演示 - Cloudflare D1 实战</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #2563eb;
            --secondary: #475569;
            --accent: #10b981;
            --code-bg: #1e293b;
            --text-code: #e2e8f0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; line-height: 1.6; background: var(--bg-color); color: #1e293b; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 40px; }

        /* SVG Diagram Styling */
        .diagram-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            text-align: center;
            overflow-x: auto;
        }
        svg { max-width: 100%; height: auto; }
        .path-flow { stroke-dasharray: 10; animation: flow 1s linear infinite; }
        @keyframes flow { to { stroke-dashoffset: -20; } }

        /* Step Cards */
        .step-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
        }
        .step-title { font-size: 1.25rem; font-weight: bold; color: var(--secondary); margin-bottom: 15px; display: flex; align-items: center; }
        .step-number { background: var(--primary); color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 0.9rem; }

        /* Code Blocks */
        pre { background: var(--code-bg); color: var(--text-code); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.9rem; position: relative; }
        code { font-family: 'Consolas', 'Monaco', monospace; }
        .comment { color: #94a3b8; font-style: italic; }
        .highlight { color: #facc15; }

        .note { background: #eff6ff; border: 1px solid #dbeafe; padding: 10px; border-radius: 6px; font-size: 0.9rem; color: #1e40af; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>WinWeb 统计系统：从前端到数据库的数据之旅</h1>

    <!-- 架构可视化区域 -->
    <div class="diagram-container">
        <h3 style="margin-top:0; color:#64748b;">系统架构数据流向图</h3>
        <svg width="800" height="350" viewBox="0 0 800 350" xmlns="http://www.w3.org/2000/svg">
            <!-- 定义箭头 -->
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                </marker>
            </defs>

            <!-- 1. 前端区域 -->
            <g transform="translate(50, 100)">
                <rect x="0" y="0" width="160" height="120" rx="8" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
                <text x="80" y="30" text-anchor="middle" font-weight="bold" fill="#1e3a8a">User Browser</text>
                <text x="80" y="55" text-anchor="middle" font-size="12" fill="#3b82f6">HTML/JS (Pages)</text>
                <!-- 模拟你的 Windows 图标 -->
                <rect x="20" y="70" width="20" height="20" rx="2" fill="#3b82f6" opacity="0.8"/>
                <rect x="50" y="70" width="20" height="20" rx="2" fill="#10b981" opacity="0.8"/>
                <rect x="80" y="70" width="20" height="20" rx="2" fill="#f59e0b" opacity="0.8"/>
                <text x="80" y="110" text-anchor="middle" font-size="10" fill="#64748b">点击图标发送请求</text>
            </g>

            <!-- 连接线 1 -->
            <path d="M210 160 L320 160" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)" class="path-flow"/>
            <text x="265" y="150" text-anchor="middle" font-size="12" fill="#64748b">Fetch API</text>
            <text x="265" y="180" text-anchor="middle" font-size="10" fill="#94a3b8">POST /api/visit</text>

            <!-- 2. 后端 Worker 区域 -->
            <g transform="translate(330, 80)">
                <rect x="0" y="0" width="160" height="160" rx="8" fill="#fff7ed" stroke="#f97316" stroke-width="2"/>
                <text x="80" y="30" text-anchor="middle" font-weight="bold" fill="#9a3412">CF Worker</text>
                <text x="80" y="50" text-anchor="middle" font-size="12" fill="#c2410c">Serverless API</text>

                <!-- 逻辑展示 -->
                <rect x="20" y="70" width="120" height="60" rx="4" fill="#fff" stroke="#fdba74" stroke-dasharray="4"/>
                <text x="80" y="90" text-anchor="middle" font-size="10" fill="#c2410c">接收请求</text>
                <text x="80" y="105" text-anchor="middle" font-size="10" fill="#c2410c">提取 APP ID</text>
                <text x="80" y="120" text-anchor="middle" font-size="10" fill="#c2410c">生成 SQL</text>
            </g>

            <!-- 连接线 2 -->
            <path d="M490 160 L600 160" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)" class="path-flow"/>
            <text x="545" y="150" text-anchor="middle" font-size="12" fill="#64748b">SQL Query</text>
            <text x="545" y="180" text-anchor="middle" font-size="10" fill="#94a3b8">UPDATE counts...</text>

            <!-- 3. 数据库 D1 区域 -->
            <g transform="translate(610, 100)">
                <path d="M0,20 C0,0 140,0 140,20 L140,100 C140,120 0,120 0,100 Z" fill="#f0fdf4" stroke="#10b981" stroke-width="2"/>
                <ellipse cx="70" cy="20" rx="70" ry="20" fill="none" stroke="#10b981" stroke-width="2"/>
                <text x="70" y="65" text-anchor="middle" font-weight="bold" fill="#065f46">Cloudflare D1</text>
                <text x="70" y="85" text-anchor="middle" font-size="12" fill="#047857">SQLite Database</text>

                <!-- 数据行 -->
                <rect x="30" y="95" width="80" height="15" rx="2" fill="#10b981" opacity="0.2"/>
                <text x="70" y="106" text-anchor="middle" font-size="9" fill="#064e3b">id: 'calc' | count: 52</text>
            </g>
        </svg>
    </div>

    <!-- 步骤说明 -->

    <div class="step-card">
        <div class="step-title"><span class="step-number">1</span> 规划数据库 (The Vault)</div>
        <p>首先，我们需要在 Cloudflare D1 中创建一个简单的表格，用来像记账本一样记录每个 App 的名字和被点击的次数。</p>
        <pre><code><span class="comment">-- SQL 语句：创建一个叫 'analytics' 的表</span>
CREATE TABLE analytics (
    app_id TEXT PRIMARY KEY,  <span class="comment">-- 例如：'home', 'calculator', 'notepad'</span>
    hits INTEGER DEFAULT 0    <span class="comment">-- 访问次数，默认为 0</span>
);

<span class="comment">-- 预先插入一些数据（可选）</span>
INSERT INTO analytics (app_id, hits) VALUES ('home', 0);
INSERT INTO analytics (app_id, hits) VALUES ('calculator', 0);</code></pre>
        <div class="note">
            <strong>操作指引：</strong> 在你的电脑终端运行 <code>npx wrangler d1 create my-db</code> 创建数据库，然后通过 Wrangler 命令行执行上面的 SQL。
        </div>
    </div>

    <div class="step-card">
        <div class="step-title"><span class="step-number">2</span> 编写后端 Worker (The Traffic Cop)</div>
        <p>你需要创建一个 Cloudflare Worker，它充当中间人。它接收前端传来的 App 名字，然后去更新数据库。</p>
        <pre><code><span class="comment">// worker.js 代码片段</span>
export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    <span class="comment">// 如果请求是 "增加计数" (POST /visit)</span>
    if (url.pathname === '/visit') {
        const { appId } = await request.json(); // 获取前端传来的 App ID

        <span class="comment">// 数据库魔法：如果存在就+1，不存在就创建并设为1</span>
        await env.DB.prepare(`
            INSERT INTO analytics (app_id, hits) VALUES (?1, 1)
            ON CONFLICT(app_id) DO UPDATE SET hits = hits + 1
        `).bind(appId).run();

        return new Response("Recorded", { status: 200 });
    }

    <span class="comment">// 如果请求是 "查询当前次数" (GET /stats)</span>
    if (url.pathname === '/stats') {
        const result = await env.DB.prepare("SELECT * FROM analytics").all();
        return Response.json(result.results);
    }

    return new Response("Not Found", { status: 404 });
  }
};</code></pre>
    </div>

    <div class="step-card">
        <div class="step-title"><span class="step-number">3</span> 前端埋点 (The Sensor)</div>
        <p>这是你需要在你的“Windows 桌面” HTML 中添加的代码。它负责在用户不知不觉中发送数据。</p>

        <h3>场景 A：统计首页访问量</h3>
        <pre><code>&lt;script&gt;
  // 页面加载完成后，告诉 Worker "首页被访问了"
  window.addEventListener('DOMContentLoaded', () => {
      trackVisit('home-desktop');
  });

  // 通用的发送函数
  async function trackVisit(appName) {
      try {
          await fetch('https://你的-worker-地址.workers.dev/visit', {
              method: 'POST',
              body: JSON.stringify({ appId: appName })
          });
          console.log(`已记录 ${appName} 的访问`);
      } catch (e) {
          console.error("统计失败", e);
      }
  }
&lt;/script&gt;</code></pre>

        <h3>场景 B：统计图标点击</h3>
        <pre><code>&lt;!-- 你的 Windows 图标 --&gt;
&lt;div class="icon" onclick="trackVisit('calculator-app'); window.open('calc.html')"&gt;
    &lt;img src="calc-icon.png" /&gt;
    &lt;span&gt;计算器&lt;/span&gt;
&lt;/div&gt;</code></pre>

        <h3>场景 C：统计那些“隐藏”的 App</h3>
        <p>对于那些不在首页的 App（比如独立的 HTML 文件），你只需要在那个文件的 <code>&lt;head&gt;</code> 或 <code>&lt;body&gt;</code> 里加入同样的 Script：</p>
        <pre><code>&lt;!-- 在 hidden-game.html 里面 --&gt;
&lt;script&gt;
    // 只要这个页面被加载，它就会自己汇报
    trackVisit('hidden-secret-game');
&lt;/script&gt;</code></pre>
    </div>

    <div class="step-card" style="border-left-color: #10b981;">
        <div class="step-title"><span class="step-number" style="background: #10b981;">4</span> 如何展示数据？</div>
        <p>你想在“关于本机”或者某个统计面板里显示次数？调用 Worker 的读取接口即可。</p>
        <pre><code>async function showStats() {
    const response = await fetch('https://你的-worker-地址.workers.dev/stats');
    const data = await response.json();

    // data 长这样: [{app_id: 'home', hits: 105}, {app_id: 'calc', hits: 23}]
    // 你可以用 JS 把它们渲染成图表或者列表
    data.forEach(item => {
        document.getElementById('stats-list').innerHTML +=
            `&lt;li&gt;${item.app_id}: ${item.hits} 次&lt;/li&gt;`;
    });
}</code></pre>
    </div>

</div>

</body>
</html>
